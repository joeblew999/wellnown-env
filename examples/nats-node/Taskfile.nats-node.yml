version: '3'

# Taskfile: nats-node includable tasks
#
# Include in your Taskfile:
#   includes:
#     nats-node:
#       taskfile: Taskfile.nats-node.yml
#
# Tasks: hub, leaf, mesh, mesh:down, test, test:kv, clean, clean:logs

vars:
  # Default ports - match .env single source of truth
  HUB_PORT: '{{default "4222" .HUB_PORT}}'
  LEAF_PORT: '{{default "4223" .LEAF_PORT}}'
  LEAF_NAME: '{{default "svc-test" .LEAF_NAME}}'

tasks:
  default:
    cmds:
      - task --list-all

  #############################################################################
  # Run Individual Nodes
  #############################################################################

  hub:
    desc: Run as hub node (standalone mode)
    env:
      NATS_NAME: hub
      NATS_PORT: '{{.HUB_PORT}}'
      NATS_DATA: ./.data/hub
      GOWORK: 'off'
    cmds:
      - go run main.go

  leaf:
    desc: Run as leaf node (requires hub running)
    env:
      NATS_NAME: '{{.LEAF_NAME}}'
      NATS_PORT: '{{.LEAF_PORT}}'
      NATS_HUB: 'nats://localhost:{{.HUB_PORT}}'
      NATS_DATA: './.data/{{.LEAF_NAME}}'
      GOWORK: 'off'
    cmds:
      - go run main.go

  #############################################################################
  # Run Full Mesh via Process-Compose
  #############################################################################

  mesh:
    desc: Run full mesh (1 hub + 4 leaves) detached
    cmds:
      - process-compose up --detached

  mesh:tui:
    desc: Run full mesh with TUI (foreground)
    cmds:
      - process-compose up

  mesh:down:
    desc: Stop the mesh
    cmds:
      - process-compose down

  mesh:attach:
    desc: Attach to mesh TUI
    cmds:
      - process-compose attach

  mesh:list:
    desc: List mesh processes
    cmds:
      - process-compose process list

  #############################################################################
  # NATS CLI Testing
  # Note: Tests automatically detect auth mode from .auth/ directory
  # Auth args are generated by scripts/nats-auth.sh
  #############################################################################

  # Internal helper: run nats CLI with auto-detected auth
  _nats:
    internal: true
    cmds:
      - nats -s nats://localhost:{{.HUB_PORT}} $(./scripts/nats-auth.sh) {{.CMD}}

  test:
    desc: Run all NATS tests
    cmds:
      - task: test:account
      - task: test:kv
      - task: test:services
      - task: test:pubsub

  test:account:
    desc: Show account info (works without system account)
    cmds:
      - task: _nats
        vars: { CMD: 'account info' }

  test:info:
    desc: Show hub server info (requires system account)
    cmds:
      - task: _nats
        vars: { CMD: 'server info' }

  test:ping:
    desc: Ping the hub (requires system account with NSC)
    cmds:
      - task: _nats
        vars: { CMD: 'server ping' }

  test:kv:
    desc: List KV buckets
    cmds:
      - task: _nats
        vars: { CMD: 'kv ls' }

  test:services:
    desc: List registered services
    cmds:
      - |
        AUTH_ARGS=$(./scripts/nats-auth.sh)
        echo "=== Services Registry ==="
        nats -s nats://localhost:{{.HUB_PORT}} $AUTH_ARGS kv ls services_registry 2>/dev/null | while read key; do
          [ -z "$key" ] && continue
          nats -s nats://localhost:{{.HUB_PORT}} $AUTH_ARGS kv get services_registry "$key" 2>/dev/null
          echo ""
        done || echo "(no services registered)"

  test:pubsub:
    desc: Test pub/sub (sends test message)
    cmds:
      - |
        AUTH_ARGS=$(./scripts/nats-auth.sh)
        echo "Publishing test message..."
        echo '{"test":"hello from nats-node"}' | nats -s nats://localhost:{{.HUB_PORT}} $AUTH_ARGS pub test.nats-node
        echo "Done. Subscribe with: nats -s nats://localhost:{{.HUB_PORT}} sub 'test.>'"

  test:lifecycle:
    desc: Run auth lifecycle regression tests (Go tests)
    env:
      GOWORK: 'off'
    cmds:
      - go test -v -run TestAuthLifecycle -timeout 5m

  test:transitions:
    desc: Run auth mode transition tests (Go tests)
    env:
      GOWORK: 'off'
    cmds:
      - go test -v -run TestAuthModeTransitions -timeout 3m

  test:all:
    desc: Run all tests (NATS + lifecycle)
    cmds:
      - task: test
      - task: test:lifecycle

  #############################################################################
  # Subscribe to Topics
  #############################################################################

  sub:all:
    desc: Subscribe to all messages
    cmds:
      - task: _nats
        vars: { CMD: 'sub ">"' }

  sub:services:
    desc: Watch service registry changes
    cmds:
      - task: _nats
        vars: { CMD: 'kv watch services_registry' }

  sub:processes:
    desc: Subscribe to process-compose updates
    cmds:
      - task: _nats
        vars: { CMD: 'sub pc.processes.updates' }

  #############################################################################
  # Auth Lifecycle (see SECURITY.md)
  #############################################################################

  auth:status:
    desc: Show current auth mode
    cmds:
      - |
        if [ -f .auth/mode ]; then
          echo "Auth mode: $(cat .auth/mode)"
        else
          echo "Auth mode: none (dev)"
        fi

  auth:token:
    desc: Set up token auth (test/CI)
    cmds:
      - mkdir -p .auth
      - |
        if [ ! -f .auth/token ]; then
          openssl rand -hex 32 > .auth/token
        fi
        echo "token" > .auth/mode
        echo "Token auth configured. Token: $(cat .auth/token)"

  auth:nkey:
    desc: Set up NKey auth (staging)
    cmds:
      - mkdir -p .auth
      - |
        if ! command -v nk &>/dev/null; then
          echo "Installing nk tool..."
          go install github.com/nats-io/nkeys/nk@latest
        fi
        if [ ! -f .auth/user.nk ]; then
          # Generate user keypair - seed file contains private key
          nk -gen user > .auth/user.nk
          # Extract public key from seed (starts with U)
          nk -inkey .auth/user.nk -pubout > .auth/user.pub
        fi
        echo "nkey" > .auth/mode
        echo "NKey auth configured."
        echo "  Seed: .auth/user.nk"
        echo "  Pub:  $(cat .auth/user.pub)"

  auth:jwt:
    desc: Set up JWT auth (production)
    cmds:
      - mkdir -p .auth/creds
      - |
        if ! command -v nsc &>/dev/null; then
          echo "Installing nsc..."
          go install github.com/nats-io/nsc/v2@latest
        fi
        # Initialize operator if not exists, or select it
        nsc add operator --name wellnown --sys 2>/dev/null || nsc select operator wellnown
        # Create account if not exists (with JetStream enabled)
        nsc add account --name APP 2>/dev/null || true
        # Enable JetStream on APP account with generous limits
        nsc edit account --name APP \
          --js-mem-storage -1 \
          --js-disk-storage -1 \
          --js-streams -1 \
          --js-consumer -1
        # Create user if not exists
        nsc add user --name user --account APP 2>/dev/null || true
        # Generate creds
        nsc generate creds --account APP --name user > .auth/creds/user.creds
        echo "jwt" > .auth/mode
        echo "JWT auth configured. Creds: .auth/creds/user.creds"

  auth:clean:
    desc: Reset to dev mode (no auth)
    cmds:
      - rm -rf .auth
      - echo "Auth reset to none (dev)"

  #############################################################################
  # Cleanup
  #############################################################################

  clean:
    desc: Remove all data directories
    cmds:
      - rm -rf ./.data
      - echo "Cleaned .data/"

  clean:logs:
    desc: Remove log files
    cmds:
      - rm -rf ./.logs
      - echo "Cleaned .logs/"

  clean:auth:
    desc: Remove auth files
    cmds:
      - rm -rf ./.auth
      - echo "Cleaned .auth/"

  clean:all:
    desc: Remove all data, logs, and auth
    cmds:
      - task: clean
      - task: clean:logs
      - task: clean:auth
